<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AroBot - AI Medical Assistant</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
      }

      .header h1 {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .main-content {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .sidebar {
        width: 280px;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        padding: 1.5rem;
        overflow-y: auto;
      }

      .sidebar h3 {
        color: #1e293b;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .action-btn {
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .action-btn:hover {
        background: #4f46e5;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
      }

      .chat-messages {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
        scroll-behavior: smooth;
      }

      .message {
        margin-bottom: 1.5rem;
        max-width: 80%;
        animation: fadeInUp 0.3s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        margin-left: auto;
      }

      .message.bot {
        margin-right: auto;
      }

      .message-content {
        padding: 1rem 1.25rem;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
      }

      .message.user .message-content {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        border-bottom-right-radius: 6px;
      }

      .message.bot .message-content {
        background: #f1f5f9;
        color: #334155;
        border-bottom-left-radius: 6px;
        border: 1px solid #e2e8f0;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .message.user .message-avatar {
        background: #6366f1;
        color: white;
        margin-left: auto;
      }

      .message.bot .message-avatar {
        background: #10b981;
        color: white;
      }

      .message-time {
        font-size: 0.75rem;
        opacity: 0.6;
        margin-top: 0.5rem;
      }

      .input-container {
        padding: 1.5rem 2rem;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
        border-radius: 20px 20px 0 0;
      }

      .input-wrapper {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        position: relative;
      }

      .message-input {
        flex: 1;
        padding: 1rem 1.25rem;
        border: 2px solid #e2e8f0;
        border-radius: 25px;
        font-size: 1rem;
        resize: none;
        max-height: 120px;
        transition: all 0.2s;
        background: white;
      }

      .message-input:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .input-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .action-button {
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        transition: all 0.2s;
      }

      .send-btn {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
      }

      .send-btn:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
      }

      .send-btn:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }

      .image-btn,
      .pdf-btn {
        background: #f1f5f9;
        color: #475569;
        border: 2px solid #e2e8f0;
      }

      .image-btn:hover,
      .pdf-btn:hover {
        background: #e2e8f0;
        transform: scale(1.05);
      }

      .loading {
        display: none;
        align-items: center;
        gap: 10px;
        color: #6b7280;
        font-style: italic;
      }

      .loading.show {
        display: flex;
      }

      .loading-dots {
        display: inline-block;
      }

      .loading-dots:after {
        content: "";
        animation: dots 1.5s steps(5, end) infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60% {
          content: "...";
        }
        80%,
        100% {
          content: "";
        }
      }

      .error-message {
        background: #fef2f2;
        color: #dc2626;
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid #fecaca;
        margin-bottom: 1rem;
      }

      .welcome-message {
        text-align: center;
        padding: 3rem 2rem;
        color: #64748b;
      }

      .welcome-message h2 {
        color: #1e293b;
        margin-bottom: 1rem;
      }

      .file-input {
        display: none;
      }

      .upload-preview {
        background: #f0f9ff;
        border: 2px dashed #0ea5e9;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: center;
        color: #0369a1;
        display: none;
      }

      .upload-preview.show {
        display: block;
      }

      .typing-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 1rem;
        color: #64748b;
        font-style: italic;
      }

      .typing-indicator.show {
        display: flex;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dots span {
        width: 6px;
        height: 6px;
        background: #94a3b8;
        border-radius: 50%;
        animation: typing 1.4s ease-in-out infinite both;
      }

      .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .sidebar {
          display: none;
        }

        .container {
          margin: 0;
          height: 100vh;
          border-radius: 0;
        }

        .header {
          border-radius: 0;
        }

        .input-container {
          border-radius: 0;
        }

        .message {
          max-width: 95%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>
          <i class="fas fa-robot"></i>
          AroBot
          <span style="font-size: 0.9rem; opacity: 0.8"
            >AI Medical Assistant</span
          >
        </h1>
        <div style="display: flex; align-items: center; gap: 8px">
          <div class="status-indicator"></div>
          <span style="font-size: 0.9rem">Online</span>
        </div>
      </div>

      <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
          <h3>Quick Actions</h3>
          <div class="quick-actions">
            <div class="action-btn" onclick="quickAction('medicine')">
              <i class="fas fa-pills" style="color: #ef4444"></i>
              Medicine Search
              <div style="font-size: 0.8rem; opacity: 0.7">
                Find medicines by condition
              </div>
            </div>
            <div class="action-btn" onclick="quickAction('symptoms')">
              <i class="fas fa-thermometer" style="color: #10b981"></i>
              Symptom Checker
              <div style="font-size: 0.8rem; opacity: 0.7">
                Analyze your symptoms
              </div>
            </div>
            <div class="action-btn" onclick="quickAction('interactions')">
              <i class="fas fa-exclamation-triangle" style="color: #f59e0b"></i>
              Drug Interactions
              <div style="font-size: 0.8rem; opacity: 0.7">
                Check medication interactions
              </div>
            </div>
          </div>

          <h3 style="margin-top: 2rem">Recent Activity</h3>
          <div style="color: #64748b; font-size: 0.9rem">
            No recent activity
          </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
              <h2>👋 Hello! I'm AroBot</h2>
              <p>Your AI Medical Assistant. I can help you with:</p>
              <div
                style="
                  margin-top: 1rem;
                  text-align: left;
                  max-width: 400px;
                  margin-left: auto;
                  margin-right: auto;
                "
              >
                <p>• Analyzing prescription images</p>
                <p>• Answering medical questions</p>
                <p>• Finding medicine information</p>
                <p>• General health consultations</p>
              </div>
              <p style="margin-top: 1rem; font-size: 0.9rem; color: #ef4444">
                ⚠️ Always consult healthcare professionals for medical advice.
              </p>
            </div>
          </div>

          <!-- Typing Indicator -->
          <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar">
              <i class="fas fa-robot"></i>
            </div>
            <span>AroBot is typing</span>
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>

          <!-- Input Container -->
          <div class="input-container">
            <div class="upload-preview" id="uploadPreview">
              <i class="fas fa-file-image"></i>
              <span id="fileName">File selected</span>
              <button
                onclick="removeFile()"
                style="
                  margin-left: 10px;
                  background: none;
                  border: none;
                  color: #dc2626;
                  cursor: pointer;
                "
              >
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="input-wrapper">
              <textarea
                class="message-input"
                id="messageInput"
                placeholder="Ask me about medications, symptoms, or upload a prescription..."
                rows="1"
              ></textarea>

              <div class="input-actions">
                <button
                  class="action-button image-btn"
                  onclick="document.getElementById('imageInput').click()"
                  title="Upload Image"
                >
                  <i class="fas fa-camera"></i>
                </button>
                <button
                  class="action-button pdf-btn"
                  onclick="document.getElementById('pdfInput').click()"
                  title="Upload PDF"
                >
                  <i class="fas fa-file-pdf"></i>
                </button>
                <button
                  class="action-button send-btn"
                  id="sendButton"
                  onclick="sendMessage()"
                  title="Send Message"
                >
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden file inputs -->
    <input
      type="file"
      id="imageInput"
      class="file-input"
      accept="image/*"
      onchange="handleFileSelect(this, 'image')"
    />
    <input
      type="file"
      id="pdfInput"
      class="file-input"
      accept=".pdf"
      onchange="handleFileSelect(this, 'pdf')"
    />

    <script>
      let currentFile = null;
      let sessionId = generateSessionId();

      function generateSessionId() {
        return (
          "session_" +
          Math.random().toString(36).substr(2, 9) +
          "_" +
          Date.now()
        );
      }

      function quickAction(type) {
        const prompts = {
          medicine:
            "I want to search for medicines. What condition would you like me to help you find treatment for?",
          symptoms:
            "I can help analyze your symptoms. Please describe what symptoms you're experiencing.",
          interactions:
            "I can check for drug interactions. Please tell me which medications you're taking.",
        };

        if (prompts[type]) {
          addMessage("bot", prompts[type]);
        }
      }

      function handleFileSelect(input, type) {
        const file = input.files[0];
        if (file) {
          currentFile = { file: file, type: type };
          document.getElementById("fileName").textContent = file.name;

          // Update icon based on file type
          const preview = document.getElementById("uploadPreview");
          const icon = preview.querySelector("i");
          if (type === "pdf") {
            icon.className = "fas fa-file-pdf";
            icon.style.color = "#dc2626";
          } else {
            icon.className = "fas fa-file-image";
            icon.style.color = "#0ea5e9";
          }

          preview.classList.add("show");
        }
      }

      function removeFile() {
        currentFile = null;
        document.getElementById("uploadPreview").classList.remove("show");
        document.getElementById("imageInput").value = "";
        document.getElementById("pdfInput").value = "";
      }

      function addMessage(sender, content, timestamp = null) {
        const messagesContainer = document.getElementById("chatMessages");
        const welcomeMessage =
          messagesContainer.querySelector(".welcome-message");

        if (welcomeMessage) {
          welcomeMessage.style.display = "none";
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const time =
          timestamp ||
          new Date().toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });
        const avatar =
          sender === "user"
            ? '<i class="fas fa-user"></i>'
            : '<i class="fas fa-robot"></i>';

        messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
                <div class="message-time">${time}</div>
            `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function showTyping() {
        document.getElementById("typingIndicator").classList.add("show");
        const messagesContainer = document.getElementById("chatMessages");
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function hideTyping() {
        document.getElementById("typingIndicator").classList.remove("show");
      }

      async function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const message = messageInput.value.trim();

        if (!message && !currentFile) return;

        // Disable send button
        sendButton.disabled = true;

        // Add user message
        if (message) {
          addMessage("user", message);
        }

        if (currentFile) {
          addMessage("user", `📎 Uploaded: ${currentFile.file.name}`);
        }

        // Clear input
        messageInput.value = "";
        messageInput.style.height = "auto";

        // Show typing indicator
        showTyping();

        try {
          let response;

          if (currentFile && currentFile.type === "image") {
            // Handle image upload
            const formData = new FormData();
            formData.append("file", currentFile.file);
            if (message) formData.append("query", message);
            formData.append("session_id", sessionId);

            response = await fetch("/api/v1/prescription/upload", {
              method: "POST",
              body: formData,
            });
          } else if (currentFile && currentFile.type === "pdf") {
            // Handle PDF upload
            const formData = new FormData();
            formData.append("file", currentFile.file);
            if (message) formData.append("description", message);
            formData.append("session_id", sessionId);

            response = await fetch("/api/v1/pdf/upload", {
              method: "POST",
              body: formData,
            });
          } else {
            // Handle text message
            response = await fetch("/api/v1/chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                message: message,
                session_id: sessionId,
                use_web_search:
                  document.getElementById("webSearchCheck")?.checked || false,
              }),
            });
          }

          hideTyping();

          if (response.ok) {
            const data = await response.json();
            let responseMessage =
              data.response ||
              data.analysis ||
              data.message ||
              "I received your message.";

            // Add additional info for successful uploads
            if (data.chunks_processed) {
              responseMessage += `\n\n📊 Processed ${data.chunks_processed} text chunks from the document.`;
            }

            addMessage("bot", responseMessage);
          } else {
            const errorData = await response.json().catch(() => ({}));
            addMessage(
              "bot",
              `❌ ${
                errorData.detail ||
                "Sorry, I encountered an error. Please try again."
              }`
            );
          }
        } catch (error) {
          hideTyping();
          addMessage(
            "bot",
            "❌ Connection error. Please check your internet connection and try again."
          );
          console.error("Error:", error);
        }

        // Reset
        removeFile();
        sendButton.disabled = false;
        messageInput.focus();
      }

      // Auto-resize textarea
      document
        .getElementById("messageInput")
        .addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 120) + "px";
        });

      // Enter to send (Shift+Enter for new line)
      document
        .getElementById("messageInput")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

      // Initialize session
      async function initializeSession() {
        try {
          await fetch("/api/v1/session/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: sessionId,
            }),
          });
        } catch (error) {
          console.error("Failed to initialize session:", error);
        }
      }

      // Initialize when page loads
      window.addEventListener("load", function () {
        initializeSession();
        document.getElementById("messageInput").focus();
      });
    </script>
  </body>
</html>
