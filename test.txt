┌─────────────────────────────────────────────────────────────────────────────────┐
│                    AroBot Agentic RAG Multi-Modal Chatbot System                │
│                        Detailed Workflow & Tool Selection Diagram               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              SYSTEM ARCHITECTURE                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🌐 FRONTEND LAYER                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ • Web UI (chat_enhanced.html)                                          │    │
│  │ • Static Assets (icons, favicon)                                       │    │
│  │ • API Client Integration                                               │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  🚀 API LAYER (FastAPI)                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ • Main Application (api/main.py)                                       │    │
│  │ • Middleware Stack:                                                    │    │
│  │   - Error Handler Middleware                                           │    │
│  │   - Rate Limiter Middleware                                            │    │
│  │   - Request Logger Middleware                                          │    │
│  │ • CORS Configuration                                                   │    │
│  │ • Health Check Endpoints                                               │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  🛣️ ROUTING LAYER                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ API v1 (Stable):                                                       │    │
│  │ • /api/v1/agent - Unified Agent Endpoint                              │    │
│  │ • /api/v1/health - Health Check                                       │    │
│  │ • /api/v1/legacy - Legacy Endpoints                                   │    │
│  │                                                                        │    │
│  │ API v2 (Latest):                                                       │    │
│  │ • /api/v2/chat - Enhanced Chat                                        │    │
│  │ • /api/v2/multimodal - Multi-modal Processing                         │    │
│  │ • /api/v2/tools - Tool Management                                     │    │
│  │                                                                        │    │
│  │ Admin:                                                                 │    │
│  │ • /admin/analytics - Usage Analytics                                  │    │
│  │ • /admin/system - System Management                                   │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  🤖 AGENT CORE LAYER (LLM-as-Agent Architecture)                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ • LLMAgent (core/agent_core.py)                                       │    │
│  │ • Tool Registry (core/enhanced_tool_registry.py)                      │    │
│  │ • Modular LLM Handler (core/llm_modular.py)                           │    │
│  │ • Medical Agent (agents/medical_agent.py)                             │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                        DETAILED WORKFLOW PROCESS                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  📥 STEP 1: REQUEST RECEPTION & INITIALIZATION                                │
└─────────────────────────────────────────────────────────────────────────────────┘

[User Input] → [FastAPI Router] → [Middleware Processing] → [Agent Core]
     ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Input Types Supported:                                                        │
│  • Text Queries (medical questions, symptoms, general chat)                    │
│  • Image Files (prescriptions, medical diagrams, photos)                      │
│  • PDF Files (medical documents, research papers)                             │
│  • Multi-modal Combinations (text + image, text + PDF)                        │
└─────────────────────────────────────────────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Session Management:                                                           │
│  • Check for existing session_id                                              │
│  • Initialize new session if needed (MCP Handler)                             │
│  • Load conversation context from memory                                      │
│  • Generate unique request ID for tracking                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  📊 STEP 2: INPUT ANALYSIS & CLASSIFICATION                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Input Description Generation:                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ def _describe_input(text_input, image_data, pdf_data):                 │    │
│  │     if image_data:                                                     │    │
│  │         return "Image file uploaded for analysis"                      │    │
│  │     elif pdf_data:                                                     │    │
│  │         return "PDF file uploaded for analysis"                        │    │
│  │     elif text_input:                                                   │    │
│  │         return f"Text query: {text_input}"                             │    │
│  │     else:                                                              │    │
│  │         return "Empty request"                                         │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Medical Intent Detection:                                                     │
│  • Medicine queries (drug names, dosages, side effects)                       │
│  • Prescription analysis requests                                             │
│  • General medical questions                                                  │
│  • Anatomy/physiology queries                                                 │
│  • Policy/regulation questions                                                │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🔧 STEP 3: TOOL SELECTION PROCESS                                            │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Tool Selection Strategy:                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ 1. Cache Check:                                                        │    │
│  │    • Generate cache key from input + context                           │    │
│  │    • Return cached selection if available                              │    │
│  │                                                                        │    │
│  │ 2. Smart Pre-filtering:                                                │    │
│  │    • Image files → analyze_image tool                                  │    │
│  │    • PDF files → analyze_pdf tool                                      │    │
│  │    • Weather queries → get_weather tool                                │    │
│  │                                                                        │    │
│  │ 3. LLM-based Selection:                                                │    │
│  │    • Send input + context to LLM                                       │    │
│  │    • LLM analyzes and selects appropriate tool(s)                      │    │
│  │    • JSON response with tool name and reasoning                        │    │
│  │                                                                        │    │
│  │ 4. Fallback Selection:                                                 │    │
│  │    • Rule-based selection if LLM fails                                 │    │
│  │    • Pattern matching for common query types                           │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Available Tools (Priority-based):                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ Priority 5 (Highest):                                                  │    │
│  │ • analyze_text - Medical questions, symptoms, general health queries   │    │
│  │                                                                        │    │
│  │ Priority 4 (High):                                                     │    │
│  │ • analyze_image - Image analysis and prescription processing           │    │
│  │ • get_medicine_info - Drug information, prices, Bangladesh brands      │    │
│  │                                                                        │    │
│  │ Priority 3 (Medium):                                                   │    │
│  │ • analyze_pdf - PDF document analysis                                  │    │
│  │ • access_memory - Previous conversation history                        │    │
│  │                                                                        │    │
│  │ Priority 2 (Low):                                                      │    │
│  │ • web_search - Current information not in knowledge base               │    │
│  │ • get_weather - Weather conditions and forecasts                       │    │
│  │                                                                        │    │
│  │ Priority 1 (Lowest):                                                   │    │
│  │ • Utility tools and fallback options                                   │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🚀 STEP 4: TOOL EXECUTION PROCESS                                            │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Tool Execution Flow:                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ for each selected tool:                                                │    │
│  │   1. Validate tool parameters                                          │    │
│  │   2. Check circuit breaker status                                      │    │
│  │   3. Execute tool function with timeout                                │    │
│  │   4. Capture execution result and metadata                             │    │
│  │   5. Update tool statistics                                            │    │
│  │   6. Handle errors and retries                                         │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Tool-Specific Execution Details:                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ 1. analyze_text Tool:                                                  │    │
│  │    • Check for greetings → LLM greeting response                       │    │
│  │    • Medical queries → RAG context retrieval                           │    │
│  │    • General queries → LLM with medical system prompt                  │    │
│  │    • Generate structured medical response                              │    │
│  │                                                                        │    │
│  │ 2. analyze_image Tool:                                                 │    │
│  │    • OCR processing (PaddleOCR)                                        │    │
│  │    • Image classification (prescription vs general)                    │    │
│  │    • LLM vision analysis                                               │    │
│  │    • Structured response generation                                    │    │
│  │                                                                        │    │
│  │ 3. get_medicine_info Tool:                                             │    │
│  │    • Medicine name extraction and normalization                        │    │
│  │    • RAG context retrieval from medical knowledge base                 │    │
│  │    • Web search for Bangladesh-specific information                    │    │
│  │    • Structured medicine information response                          │    │
│  │                                                                        │    │
│  │ 4. web_search Tool:                                                    │    │
│  │    • Query optimization for medical searches                           │    │
│  │    • DuckDuckGo API integration                                       │    │
│  │    • Result filtering and ranking                                      │    │
│  │    • Context integration with main response                            │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🔄 STEP 5: RAG (RETRIEVAL-AUGMENTED GENERATION) PROCESS                       │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  RAG Context Retrieval:                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ 1. Query Processing:                                                   │    │
│  │    • Generate embeddings for user query                                │    │
│  │    • Query Pinecone vector database                                    │    │
│  │    • Retrieve top-k relevant chunks                                    │    │
│  │                                                                        │    │
│  │ 2. Context Enhancement:                                                │    │
│  │    • Filter and rank retrieved chunks                                  │    │
│  │    • Remove duplicates and irrelevant content                          │    │
│  │    • Combine with conversation context                                 │    │
│  │                                                                        │    │
│  │ 3. LLM Integration:                                                    │    │
│  │    • Inject context into LLM prompt                                    │    │
│  │    • Use medical system prompts                                        │    │
│  │    • Generate context-aware responses                                  │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Knowledge Base Sources:                                                       │
│  • Medical textbooks and references                                           │
│  │ • Bangladesh medicine database (pharma.db)                               │
│  │ • Prescription data (129 images)                                         │
│  │ • Web-scraped medicine data (CSV files)                                  │
│  │ • Clinical guidelines and protocols                                      │
│  │ • Drug interaction databases                                             │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  📝 STEP 6: RESPONSE GENERATION & SYNTHESIS                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Response Synthesis Process:                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ 1. Tool Result Aggregation:                                            │    │
│  │    • Combine results from multiple tools                               │    │
│  │    • Resolve conflicts and inconsistencies                             │    │
│  │    • Prioritize information by source reliability                      │    │
│  │                                                                        │    │
│  │ 2. LLM Response Generation:                                             │    │
│  │    • Use medical system prompts                                        │    │
│  │    • Generate structured, professional responses                       │    │
│  │    • Include source attribution and disclaimers                        │    │
│  │                                                                        │    │
│  │ 3. Quality Assurance:                                                   │    │
│  │    • Validate response completeness                                     │    │
│  │    • Check for medical accuracy                                         │    │
│  │    • Add appropriate disclaimers                                        │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Response Format:                                                              │
│  • Structured medical information                                             │
│  • Source citations and references                                            │
│  • Safety disclaimers and warnings                                            │
│  • Bangladesh-specific context when relevant                                  │
│  • Professional medical language                                              │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  💾 STEP 7: MEMORY & SESSION MANAGEMENT                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  MCP (Model Context Protocol) Handler:                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ 1. Session Management:                                                 │    │
│  │    • Create and maintain user sessions                                 │    │
│  │    • Store conversation history                                        │    │
│  │    • Track user preferences and context                                │    │
│  │                                                                        │    │
│  │ 2. Memory Operations:                                                  │    │
│  │    • Add user messages to session                                      │    │
│  │    • Store assistant responses                                         │    │
│  │    • Retrieve conversation context                                      │    │
│  │    • Manage session lifecycle                                          │    │
│  │                                                                        │    │
│  │ 3. Context Retrieval:                                                  │    │
│  │    • Load recent conversation history                                  │    │
│  │    • Provide context for tool selection                                │    │
│  │    • Enable follow-up question handling                                │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  📊 STEP 8: MONITORING & OBSERVABILITY                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  LangSmith Integration:                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ Traced Functions:                                                       │    │
│  │ • MCP Handler operations (@traceable)                                  │    │
│  │ • Web search operations                                                │    │
│  │ • OCR processing functions                                             │    │
│  │ • LLM text and vision completions                                      │    │
│  │ • Medical query processing                                             │    │
│  │ • Prescription analysis                                                │    │
│  │                                                                        │    │
│  │ Monitoring Metrics:                                                    │    │
│  │ • Request/response times                                               │    │
│  │ • Tool execution success rates                                         │    │
│  │ • Token usage and costs                                                │    │
│  │ • Error rates and patterns                                             │    │
│  │ • User session analytics                                               │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Error Handling & Recovery:                                                    │
│  • Circuit breaker pattern for failing tools                                 │
│  • Graceful degradation with fallback responses                               │
│  • Comprehensive error logging and monitoring                                 │
│  • User-friendly error messages                                              │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🔄 COMPLETE WORKFLOW EXAMPLE                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Example: "What are the side effects of paracetamol?"                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ 1. Request Reception:                                                  │    │
│  │    • User sends text query via API                                     │    │
│  │    • FastAPI routes to /api/v1/agent                                   │    │
│  │    • Middleware processes request                                       │    │
│  │                                                                        │    │
│  │ 2. Input Analysis:                                                     │    │
│  │    • Input: "Text query: What are the side effects of paracetamol?"    │    │
│  │    • Medical intent detected (medicine query)                          │    │
│  │    • Session ID: user_123_2024-01-15                                   │    │
│  │                                                                        │    │
│  │ 3. Tool Selection:                                                     │    │
│  │    • Cache check: No cached selection                                  │    │
│  │    • Pre-filtering: Medicine query detected                            │    │
│  │    • LLM selection: get_medicine_info tool                             │    │
│  │    • Reasoning: "Medicine-specific information request"                │    │
│  │                                                                        │    │
│  │ 4. Tool Execution:                                                     │    │
│  │    • Extract medicine name: "paracetamol"                              │    │
│  │    • RAG context retrieval: 4 relevant chunks                          │    │
│  │    • Web search: Bangladesh-specific information                       │    │
│  │    • LLM processing: Generate structured response                      │    │
│  │                                                                        │    │
│  │ 5. Response Generation:                                                │    │
│  │    • Combine RAG context + web search results                          │    │
│  │    • Generate structured medical response                              │    │
│  │    • Add safety disclaimers                                            │    │
│  │    • Include source attribution                                        │    │
│  │                                                                        │    │
│  │ 6. Memory Update:                                                      │    │
│  │    • Store user message in session                                     │    │
│  │    • Store assistant response                                          │    │
│  │    • Update conversation context                                       │    │
│  │                                                                        │    │
│  │ 7. Response Delivery:                                                  │    │
│  │    • Return structured response to user                                │    │
│  │    • Log metrics and trace data                                        │    │
│  │    • Update tool usage statistics                                      │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Example: Prescription Image Analysis                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ 1. Request Reception:                                                  │    │
│  │    • User uploads prescription image                                   │    │
│  │    • File type: image/jpeg                                             │    │
│  │    • File size: 2.3MB                                                  │    │
│  │                                                                        │    │
│  │ 2. Input Analysis:                                                     │    │
│  │    • Input: "Image file uploaded for analysis"                        │    │
│  │    • Image type detected                                               │    │
│  │    • Prescription analysis intent inferred                             │    │
│  │                                                                        │    │
│  │ 3. Tool Selection:                                                     │    │
│  │    • Pre-filtering: Image file detected                                │    │
│  │    • Selected tool: analyze_image                                      │    │
│  │    • Reasoning: "Image input requires OCR and analysis"                │    │
│  │                                                                        │    │
│  │ 4. Tool Execution:                                                     │    │
│  │    • OCR processing: Extract text from image                           │    │
│  │    • Image classification: Prescription detected                       │    │
│  │    • LLM analysis: Process OCR text with medical context               │    │
│  │    • Medication extraction: Identify drugs and dosages                 │    │
│  │                                                                        │    │
│  │ 5. Response Generation:                                                │    │
│  │    • Structured prescription analysis                                  │    │
│  │    • Medication list with dosages                                      │    │
│    │    • Doctor information and date                                     │    │
│  │    • Safety warnings and instructions                                  │    │
│  │                                                                        │    │
│  │ 6. Memory Update:                                                      │    │
│  │    • Store prescription analysis result                                │    │
│  │    • Link to user session                                              │    │
│  │    • Enable follow-up questions                                        │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🏗️ SYSTEM COMPONENTS & DEPENDENCIES                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Core Dependencies:                                                            │
│  • FastAPI - Web framework                                                    │
│  • Ollama - Local LLM inference                                               │
│  • LangChain - LLM framework and tooling                                      │
│  • Pinecone - Vector database for RAG                                         │
│  • PaddleOCR - OCR processing                                                 │
│  • Transformers - Hugging Face models                                         │
│  • Sentence Transformers - Text embeddings                                    │
│  • SQLite - Local database storage                                            │
│  • MCP - Model Context Protocol for memory                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  External Services:                                                            │
│  • LangSmith - LLM monitoring and tracing                                     │
│  • DuckDuckGo - Web search API                                                │
│  • OpenMeteo - Weather API                                                    │
│  • Pinecone Cloud - Vector database hosting                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Data Sources:                                                                 │
│  • Medical knowledge base (vector embeddings)                                 │
│  • Bangladesh medicine database (pharma.db)                                   │
│  • Prescription images (129 samples)                                          │
│  • Web-scraped medicine data (CSV files)                                      │
│  • Clinical guidelines and protocols                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🎯 KEY FEATURES & CAPABILITIES                                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Medical Capabilities:                                                         │
│  • Prescription analysis and medication extraction                            │
│  • Medicine information lookup with Bangladesh context                        │
│  • Drug interaction checking                                                  │
│  • Dosage and administration guidance                                         │
│  • Side effects and contraindications                                         │
│  • Clinical guidelines and protocols                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Technical Capabilities:                                                       │
│  • Multi-modal input processing (text, image, PDF)                            │
│  • Intelligent tool selection and routing                                     │
│  • RAG-enhanced responses with source attribution                             │
│  • Session-based conversation memory                                          │
│  • Real-time monitoring and observability                                     │
│  • Scalable microservices architecture                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🔧 CONFIGURATION & ENVIRONMENT                                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Environment Variables:                                                        │
│  • PINECONE_API_KEY - Vector database access                                  │
│  • LANGSMITH_API_KEY - Monitoring and tracing                                 │
│  • OLLAMA_BASE_URL - Local LLM server URL                                     │
│  • OLLAMA_TEXT_MODEL - Text generation model                                  │
│  • OLLAMA_VISION_MODEL - Image analysis model                                │
│  • DEBUG - Development mode flag                                              │
│  • APP_HOST/APP_PORT - Server configuration                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  📈 PERFORMANCE CHARACTERISTICS                                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Response Times:                                                               │
│  • Text queries: 1-3 seconds                                                  │
│  • Image analysis: 3-5 seconds                                                │
│  • PDF processing: 5-10 seconds                                               │
│  • Medicine lookups: 1-2 seconds                                              │
│  • Web searches: 2-4 seconds                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Scalability:                                                                  │
│  • Horizontal scaling via FastAPI                                             │
│  • Stateless agent design                                                     │
│  • External vector database (Pinecone)                                        │
│  • Caching for tool selection and responses                                   │
│  • Circuit breaker pattern for resilience                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🚀 DEPLOYMENT & OPERATIONS                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Development Setup:                                                            │
│  1. Install dependencies: pip install -r requirements.txt                     │
│  2. Set up environment variables in .env file                                 │
│  3. Initialize Pinecone vector database                                       │
│  4. Start Ollama server with required models                                  │
│  5. Run data ingestion scripts                                                │
│  6. Start FastAPI server: python app.py                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Production Considerations:                                                    │
│  • Use production ASGI server (Gunicorn + Uvicorn)                            │
│  • Configure proper logging and monitoring                                    │
│  │ • Set up reverse proxy (Nginx)                                            │
│  │ • Implement health checks and alerts                                       │
│  │ • Configure backup and recovery procedures                                 │
│  │ • Monitor resource usage and performance                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  🔍 DEBUGGING & TROUBLESHOOTING                                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Common Issues:                                                                │
│  • OCR failures on blurry or handwritten text                                 │
│  • RAG context retrieval timeouts                                             │
│  • Web search API rate limits                                                 │
│  • LLM model loading and memory issues                                        │
│  • Vector database connection problems                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Debugging Tools:                                                              │
│  • LangSmith traces for request flow analysis                                 │
│  • Comprehensive logging throughout the system                                │
│  • Health check endpoints for component status                                │
│  • Tool execution statistics and metrics                                      │
│  • Error tracking and alerting                                                │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  📋 SUMMARY                                                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  AroBot is a sophisticated LLM-as-Agent medical chatbot system that:           │
│                                                                                 │
│  • Uses intelligent tool selection to automatically choose the right           │
│    processing pipeline for each user request                                   │
│                                                                                 │
│  • Supports multi-modal input (text, images, PDFs) with specialized           │
│    processing for each type                                                     │
│                                                                                 │
│  • Leverages RAG (Retrieval-Augmented Generation) to provide accurate,         │
│    context-aware medical information                                           │
│                                                                                 │
│  • Maintains conversation memory and context across sessions                   │
│                                                                                 │
│  • Provides comprehensive monitoring and observability through LangSmith       │
│                                                                                 │
│  • Scales horizontally and handles high-volume medical queries efficiently     │
│                                                                                 │
│  The system architecture follows modern microservices patterns with clear      │
│  separation of concerns, making it maintainable and extensible for future      │
│  medical AI applications.                                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

# Enhanced Image Classification System - Implementation Complete

## Overview
Successfully implemented advanced image classification system with the following improvements:

## Key Features Implemented:

### 1. Multi-Stage Classification Pipeline
- **Visual Analysis**: Detects layout features, medical symbols, scan characteristics
- **Text Analysis**: Enhanced OCR processing with medical entity recognition
- **Context Analysis**: User intent detection and session context awareness
- **Confidence Scoring**: Multi-dimensional confidence calculation

### 2. Detailed Image Categories
- **Prescription**: Traditional doctor prescriptions with medicines
- **Medicine Package**: Individual medicine boxes, bottles, strips
- **Lab Results**: Blood tests, urine tests, medical reports
- **Anatomy Diagram**: Educational diagrams and body part illustrations
- **Medical Chart**: Graphs, measurement tools, medical charts
- **Medical Scan**: X-rays, CT scans, MRI images
- **General Image**: Fallback for other image types

### 3. Specialized Processing Handlers
Each image category has dedicated processing:
- **Prescription Handler**: Medicine extraction + RAG knowledge lookup
- **Package Handler**: Brand identification + safety information
- **Lab Results Handler**: Value interpretation + normal range analysis
- **Anatomy Handler**: Educational context + knowledge base integration
- **Scan Handler**: Basic analysis with professional disclaimer

### 4. Enhanced Frontend Classification
- **Filename Analysis**: Detects hints from file names
- **Message Context**: Analyzes user questions for intent
- **Confidence Hints**: Provides classification confidence to backend
- **Metadata Passing**: Rich context information for better classification

### 5. Confidence-Based Routing
- High confidence (>0.7): Direct specialized processing
- Medium confidence (0.4-0.7): Enhanced analysis with fallbacks
- Low confidence (<0.4): General processing with basic OCR

## Files Modified:
1. `core/multimodal_processor.py` - Added advanced classification system
2. `core/agent_core.py` - Updated analyze_image tool with specialized handlers
3. `api/routes/v1/agent.py` - Enhanced endpoint with context processing
4. `templates/chat_enhanced.html` - Improved frontend classification logic
5. `api/schemas/responses.py` - Added metadata field for classification info

## Benefits:
- **Precise Classification**: No more treating medicine packages as prescriptions
- **Context Awareness**: Considers user intent and conversation history
- **Specialized Responses**: Each image type gets appropriate processing
- **Better User Experience**: More relevant and accurate responses
- **Confidence Transparency**: Users know how certain the system is
- **Extensible Design**: Easy to add new image categories

## Testing Scenarios:
1. Upload prescription image → Should classify as "prescription" with medicine info
2. Upload medicine bottle → Should classify as "medicine_package" with safety info
3. Upload lab results → Should classify as "lab_results" with interpretation
4. Upload anatomy diagram → Should classify as "anatomy_diagram" with educational content
5. Upload general image → Should classify as "general_image" with basic analysis

The system now intelligently distinguishes between different medical image types and provides specialized, contextually appropriate responses!

## Bug Fixes Applied:

### Issue: Connection Error (422 Unprocessable Entity)
**Problem**: Frontend was getting connection errors when uploading images due to:
1. Missing `imageTypeHint` assignment for lab results
2. Incorrect property references (`currentFile.name` instead of `currentFile.file.name`)
3. Wrong parameter name (`question` instead of `message`)
4. Problematic `@handle_agent_errors` decorator causing parameter validation issues

**Fixes Applied**:
1. ✅ Fixed missing `imageTypeHint = 'lab_results'` assignment
2. ✅ Corrected `currentFile.file.name` and `currentFile.file.size` references
3. ✅ Changed frontend to send `message` parameter instead of `question`
4. ✅ Removed problematic `@handle_agent_errors` decorator from API endpoint
5. ✅ Added proper error handling directly in the endpoint function
6. ✅ Cleaned up duplicate imports in `multimodal_processor.py`

### Current Status: FIXED ✅
The API endpoint should now properly accept image uploads without validation errors.

## Test Command:
```bash
# Test the API endpoint with a simple image upload
curl -X POST "http://localhost:8000/api/v1/agent" \
  -F "file=@path/to/image.jpg" \
  -F "message=What medicine is this?" \
  -F "image_type=medicine_package" \
  -F "confidence_hint=0.8"
```
## Additional Bug Fixes Applied:

### Issue: Prescription Misclassified as Anatomy Diagram
**Problem**: The system was incorrectly classifying clear prescription images as "Anatomy Diagram" with low confidence (40.6%) instead of "Prescription" with high confidence.

**Root Causes**:
1. **Medicine patterns too restrictive**: Only looked for "tab" but prescription had "Tab." (with period)
2. **Prescription format detection incomplete**: Missing key patterns like patient info, physical findings, BP, weight, etc.
3. **Scoring weights imbalanced**: Prescription max score was 1.0, anatomy was 0.9 - too close
4. **Missing Bengali text handling**: Prescription had Bengali text that wasn't being detected

**Fixes Applied**:
1. ✅ **Enhanced Medicine Patterns**: Added support for "Tab.", "Syp.", "Cap.", "Inj." formats
2. ✅ **Improved Prescription Detection**: Added 15+ new patterns including:
   - Patient ID, Age, Sex fields
   - Blood pressure (BP), Weight, Height, Glucose
   - Prescription, Medicine, Advice, History keywords
   - Physical findings section
3. ✅ **Rebalanced Scoring Weights**:
   - Prescription: 0.6 + 0.4 + 0.3 + 0.2 + 0.2 + 0.2 = 1.9 max score
   - Anatomy: 0.3 + 0.2 + 0.1 = 0.6 max score (reduced)
4. ✅ **Better Pattern Matching**: Lowered threshold to 3 matches but require more comprehensive detection

### Expected Results:
- **Prescription images** should now be classified as "prescription" with 80-95% confidence
- **Medicine packages** should be classified as "medicine_package" with 70-90% confidence  
- **Anatomy diagrams** should only be classified as such when they actually contain anatomy content
- **False positives** should be significantly reduced

### Test the Fix:
Upload the same prescription image again - it should now be correctly classified as "Prescription" with high confidence and provide detailed medicine information about Bigmet, Consucon, Flexifen, Indever, and Anaflex.

### Issue: Missing Medicine Extraction Methods
**Problem**: The LLMAgent class was missing the `_extract_medicine_names_from_ocr` and `_extract_medicine_names_from_text` methods that were being called in the prescription and medicine package handlers.

**Error**: `AttributeError: 'LLMAgent' object has no attribute '_extract_medicine_names_from_ocr'`

**Fix Applied**:
1. ✅ **Added `_extract_medicine_names_from_ocr` method**: Extracts medicine names from OCR text using enhanced regex patterns
2. ✅ **Added `_extract_medicine_names_from_text` method**: Extracts medicine names from analysis text/vision responses
3. ✅ **Enhanced Pattern Matching**: Both methods use comprehensive regex patterns to detect:
   - Tab./Tab, Syp./Syp, Cap./Cap, Inj./Inj formats
   - Medicine names with mg/ml units
   - Complex medicine formats with multiple units
4. ✅ **Smart Filtering**: Removes common non-medicine words and validates medicine names

**Methods Added**:
- `_extract_medicine_names_from_ocr(ocr_text: str) -> List[str]`
- `_extract_medicine_names_from_text(text: str) -> List[str]`

### Current Status: FIXED ✅
The prescription image processing should now work without AttributeError. The system will properly extract medicine names from both OCR text and vision analysis responses.
